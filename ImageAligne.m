close all
clear all
%----Set Variables-----% 

ffile='filename';  
ffile2='filename';  
altphysfile='filename'; 
fr_finaltime=0;

cc=1;  
cc2=1; 

xl=0;  xu=0;  vl=0;
%% 
%----Set Figure-----------------------------------------------------------------------------------------------------------% 
z_scrsz = get(0,'ScreenSize');
fs=figure(1); set(fs,'Units','normalized','Position',[0.0 0.05 1 0.85],'Name','Na analysis');

figure(1);subplot('Position',[0.02 0.69 0.37 0.25]);
uicontrol(fs,'Units','normalized','BackGroundColor',[0.7 0.7 0.7],'Position',[0.01 0.64 0.39 0.01]);
figure(1);subplot('Position',[0.02 0.35 0.37 0.25]);
uicontrol(fs,'Units','normalized','BackGroundColor',[0.7 0.7 0.7],'Position',[0.01 0.32 0.39 0.01]);
figure(1);subplot('Position',[0.02 0.02 0.37 0.25]);

figure(1);subplot('Position',[0.5 0.65 0.37 0.3]);
figure(1);subplot('Position',[0.5 0.33 0.37 0.3]);
figure(1);subplot('Position',[0.5 0.02 0.37 0.3]);
 
 
uicontrol(fs,'Units','normalized','BackGroundColor',[0.7 0.7 0.7],'Position',[0.401 0.00 0.005 1]); 
uicontrol(fs,'Units','normalized','BackGroundColor',[0.7 0.7 0.7],'Position',[0.48 0.00 0.005 1]);

%---Experimental parameters---%
uicontrol(fs,'Style','text','Units','normalized','BackGroundColor',[0.6 0.6 0.6],'Position',[0.02 0.955 0.38 0.05]);
z_name=uicontrol(fs,'Style','text' ,'Fontsize',8,'Units','normalized','BackGroundColor',[0.85 0.85 0.85],...
 'Position',[0.02 0.965 0.13 0.03],'String',ffile);
z_time=uicontrol('Style','edit','FontSize',8,'Units','normalized',...
    'Position',[0.25 0.965 0.03 0.03],'String','1',...
    'Callback',['fr_time=str2num(get(z_time,''String''));finaltime=fr_time;']);

uicontrol('Style','text','FontSize',8,'Units','normalized','BackGroundColor',[0.85 0.85 0.85],...
    'Position',[0.155 0.965 0.1 0.03],'String','Acq.time (us):');
z_finaltime=uicontrol('Style', 'checkbox','Units','normalized','FontSize',8,...
     'Position', [0.23 0.965 0.02 0.02],'String', '',...
     'Callback',['fr_finaltime=get(z_finaltime,''Value'');']);
z_frames=uicontrol('Style','text','FontSize',8,'Units','normalized','BackGroundColor',[0.85 0.85 0.85],...
    'Position',[0.325 0.965 0.02 0.03],'String',cc);
uicontrol('Style','text','FontSize',8,'Units','normalized','BackGroundColor',[0.85 0.85 0.85],...
    'Position',[0.285 0.965 0.04 0.03],'String','frames:');


%---Experimental parameters---%
uicontrol(fs,'Style','text','Units','normalized','BackGroundColor',[0.6 0.6 0.6],'Position',[0.5 0.955 0.38 0.05]);
z_name2=uicontrol(fs,'Style','text' ,'Fontsize',8,'Units','normalized','BackGroundColor',[0.85 0.85 0.85],...
 'Position',[0.5 0.965 0.13 0.03],'String',ffile2);
z_time2=uicontrol('Style','edit','FontSize',8,'Units','normalized',...
    'Position',[0.73 0.965 0.03 0.03],'String','1',...
    'Callback',['fr_time2=str2num(get(z_time2,''String''));']);
uicontrol('Style','text','FontSize',8,'Units','normalized','BackGroundColor',[0.85 0.85 0.85],...
    'Position',[0.635 0.965 0.1 0.03],'String','Acq.time (us):');
z_frames2=uicontrol('Style','text','FontSize',8,'Units','normalized','BackGroundColor',[0.85 0.85 0.85],...
    'Position',[0.805 0.965 0.02 0.03],'String',cc2);
uicontrol('Style','text','FontSize',8,'Units','normalized','BackGroundColor',[0.85 0.85 0.85],...
    'Position',[0.765 0.965 0.04 0.03],'String','frames:');



uicontrol(fs,'Style','push','Units','normalized',...
 'String','Load file1','Position',[0.41 0.96 0.07 0.03],...
'Callback',['[ffile fpath]=uigetfile(''*.mat'',''load experiment'');'...
 'eval([''load '',fpath ''\'' ffile]);'...
 'Ya=double(Y); [ca cb cc]= size(Ya); clear Y;'...
 'avg=(mean(Ya(:,:,1:cc),3));'...
 'figure(1); subplot(''Position'',[0.02 0.69 0.37 0.25]); imshow(avg,[]);title(''Image1'');'...
 'set(z_frames ,''string'', cc); set (z_name , ''string'', ffile);'...
    'if ffile(2)==''C'',altphysfile=[ffile(2:end)]; '...
   'if (exist([fpath ''\'' altphysfile])),altphys = load([fpath ''\'' altphysfile]);'...
  'fr_time=altphys.acq_t; Vm=altphys.Y1(1:cc*fr_time/0.05);set(z_time,''String'',fr_time); '... 
  'figure(1);subplot(''Position'',[0.5 0.65 0.37 0.3]);plot((1:cc*fr_time/0.05)*0.05,Vm );grid(''on'');clear altphys;end;'...
 'else, if (exist([fpath ''\'' ffile(2:end)])),'...
'Phys = load([fpath ''\'' ffile(2:end)]); Vm=Phys.Y1(1:cc*fr_time/0.05);'...
'if fr_finaltime==0,fr_time=str2num(Phys.acq_t);else, fr_time=finaltime;end;'...
'clear Phys;'...
'clear Phys;'...
'figure(1);subplot(''Position'',[0.5 0.65 0.37 0.3]);plot((1:cc*fr_time/0.05)*0.05,Vm );grid(''on'');end;end;'...
'clearvars  w* W*;']);

uicontrol(fs,'Style','push','Units','normalized',...
 'String','Load file2','Position',[0.41 0.92 0.07 0.03],...
'Callback',['[ffile2 fpath2]=uigetfile(''*.mat'',''load experiment'');'...
 'eval([''load '',fpath2 ''\'' ffile2]);,',...
 'Ya2=double(Y); [ca2 cb2 cc2]= size(Ya2); clear Y;'...
 'avg2=(mean(Ya2(:,:,1:cc2),3));'...
 'figure(1); subplot(''Position'',[0.02 0.35 0.37 0.25]); imshow(avg2,[]);title(''Image2'');'...
 'set(z_frames2 ,''string'', cc2); set (z_name2 , ''string'', ffile2);'...
 'if ffile2(2)==''C'','...
   'altphysfile=[ffile2(2:end)]; if (exist([fpath2 ''\'' altphysfile])),altphys = load([fpath2 ''\'' altphysfile]);'...
  'fr_time2=altphys.acq_t;set(z_time2,''String'',fr_time2);Vm2=altphys.Y1(1:cc2*fr_time2/0.05);'... 
  'figure(1);subplot(''Position'',[0.5 0.33 0.37 0.3]);plot((1:cc*fr_time2/0.05)*0.05,Vm2 );grid(''on'');clear altphys;end;'...
 'else, if (exist([fpath2 ''\'' ffile2(2:end)])),'...
'Phys2 = load([fpath2 ''\'' ffile2(2:end)]);  Vm2=Phys2.Y1(1:cc*fr_time/0.05);'...
'if fr_finaltime==0,fr_time2=str2num(Phys2.acq_t);else, fr_time2=finaltime;end;'...
'clear Phys2;'...
'figure(1);subplot(''Position'',[0.5 0.33 0.37 0.3]);plot((1:cc2*fr_time2/0.05)*0.05,Vm2 );grid(''on'');end;end;'...
'controlv=1;WX=ones(3*ca2,cb2,cc2);'...
'for wi=1:ca2,WX(wi,:,:)=WX(wi,:,:).*Ya2(1,:,:);end;'...
'WX(ca2+1:2*ca2,:,:)=Ya2(:,:,:);'...
'for wi=2*ca2+1:3*ca2, WX(wi,:,:)=WX(wi,:,:).*Ya2(ca2,:,:);end;'...
'WY=ones(3*ca2,3*cb2,cc2);'...
'for wi=1:cb2,WY(:,wi,:)=WX(:,1,:);end;'...
'WY(:,cb2+1:2*cb2,:)=WX(:,:,:);'...
'for wi=2*cb2+1:3*cb2,WY(:,wi,:)=WX(:,cb2,:);end;'...
'WZ=ones(3*ca2,3*cb2,3*cc2);'...
'for wi=1:cc2,WZ(:,:,wi)=WY(:,:,1);end;'...
'WZ(:,:,cc2+1:2*cc2)=WY;'...
'for wi=2*cc2+1:3*cc2,WZ(:,:,wi)=WY(:,:,cc2);end;'...
 'Yacr=ones(size(WZ)); Yacr=WZ;'...
 'for wi=1:size(Vm2), Vmcr(wi,1)=Vm2(1);end;'...
 'Vmcr(size(Vm2)+1:2*size(Vm2),1)=Vm2;'...
 'for wi=2*size(Vm2)+1:3*size(Vm2), Vmcr(wi,1)=Vm2(end);end;'...
'clearvars  w* W*;']);



uicontrol(fs,'Style','push','Units','normalized',...
 'String','Fuse','Position',[0.41 0.88 0.07 0.03],...
'Callback',['W1=avg; W1=1.7*W1./ max(W1(:)); '...
  'W2=avg2; W2=W2./ max(W2(:)); '...
'avgfuse = imfuse(W1,W2,''falsecolor'',''Scaling'',''joint'',''ColorChannels'',[1 2 0]);'...
'figure(1); subplot(''Position'',[0.02 0.02 0.37 0.25]); imshow(avgfuse,[]);title(''Fused'');'...
'figure(1);subplot(''Position'',[0.5 0.02 0.37 0.3]);plot((1:cc*fr_time/0.05)*0.05,Vm ,(1:cc2*fr_time2/0.05)*0.05,Vm2 );grid(''on'');'...
'clearvars  w* W*;']);

uicontrol(fs,'Style','push','Fontsize',8,'Units','normalized',...
 'Position',[0.41 0.84 0.016 0.02],'String','<',...
 'Callback',['xl=xl-1;'...
 'Ya2=Yacr(ca2+1+xu:2*ca2+xu,cb2+1+xl:2*cb2+xl,cc2+1+vl:2*cc2+vl);'...
 'avg2=(mean(Ya2(:,:,1:cc),3));'...
 'figure(1);subplot(''Position'',[0.02 0.35 0.37 0.25]);imshow(avg2,[]);'...
  'W1=avg; W1=2*W1./ max(W1(:)); '...
  'W2=avg2; W2=W2./ max(W2(:)); '...
'avgfuse = imfuse(W1,W2,''falsecolor'',''Scaling'',''joint'',''ColorChannels'',[1 2 0]);'...
'figure(1); subplot(''Position'',[0.02 0.02 0.37 0.25]); imshow(avgfuse,[]);title(''Fused'');'...
'clearvars  w* W*;']);

uicontrol(fs,'Style','push','Fontsize',8,'Units','normalized',...
 'Position',[0.425 0.84 0.016 0.02],'String','>',...
 'Callback',['xl=xl+1;'...
  'Ya2=Yacr(ca2+1+xu:2*ca2+xu,cb2+1+xl:2*cb2+xl,cc2+1+vl:2*cc2+vl);'...
 'avg2=(mean(Ya2(:,:,1:cc),3));'...
 'figure(1);subplot(''Position'',[0.02 0.35 0.37 0.25]);imshow(avg2,[]);'...
  'W1=avg; W1=2*W1./ max(W1(:)); '...
  'W2=avg2; W2=W2./ max(W2(:)); '...
'avgfuse = imfuse(W1,W2,''falsecolor'',''Scaling'',''joint'',''ColorChannels'',[1 2 0]);'...
'figure(1); subplot(''Position'',[0.02 0.02 0.37 0.25]); imshow(avgfuse,[]);title(''Fused'');'...
'clearvars  w* W*;']);

uicontrol(fs,'Style','push','Fontsize',8,'Units','normalized',...
 'Position',[0.4495 0.84 0.016 0.02],'String','u',...
 'Callback',['xu=xu+1;'...
  'Ya2=Yacr(ca2+1+xu:2*ca2+xu,cb2+1+xl:2*cb2+xl,cc2+1+vl:2*cc2+vl);'...
 'avg2=(mean(Ya2(:,:,1:cc),3));'...
 'figure(1);subplot(''Position'',[0.02 0.35 0.37 0.25]);imshow(avg2,[]);'...
  'W1=avg; W1=2*W1./ max(W1(:)); '...
  'W2=avg2; W2=W2./ max(W2(:)); '...
'avgfuse = imfuse(W1,W2,''falsecolor'',''Scaling'',''joint'',''ColorChannels'',[1 2 0]);'...
'figure(1); subplot(''Position'',[0.02 0.02 0.37 0.25]); imshow(avgfuse,[]);title(''Fused'');'...
'clearvars  w* W*;']);


uicontrol(fs,'Style','push','Fontsize',8,'Units','normalized',...
 'Position',[0.465 0.84 0.016 0.02],'String','d',...
  'Callback',['xu=xu-1;'...
  'Ya2=Yacr(ca2+1+xu:2*ca2+xu,cb2+1+xl:2*cb2+xl,cc2+1+vl:2*cc2+vl);'...
 'avg2=(mean(Ya2(:,:,1:cc),3));'...
 'figure(1);subplot(''Position'',[0.02 0.35 0.37 0.25]);imshow(avg2,[]);'...
  'W1=avg; W1=2*W1./ max(W1(:)); '...
  'W2=avg2; W2=W2./ max(W2(:)); '...
'avgfuse = imfuse(W1,W2,''falsecolor'',''Scaling'',''joint'',''ColorChannels'',[1 2 0]);'...
'figure(1); subplot(''Position'',[0.02 0.02 0.37 0.25]); imshow(avgfuse,[]);title(''Fused'');'...
'clearvars  w* W*;']);


uicontrol(fs,'Style','push','Fontsize',8,'Units','normalized',...
 'Position',[0.41 0.79 0.03 0.03],'String','V2->',...
  'Callback',['vl=vl+1;'...
  'Ya2=Yacr(ca2+1+xu:2*ca2+xu,cb2+1+xl:2*cb2+xl,cc2+1+vl:2*cc2+vl);'...
 'avg2=(mean(Ya2(:,:,1:cc),3));'...
 'figure(1);subplot(''Position'',[0.02 0.35 0.37 0.25]);imshow(avg2,[]);'...
  'W1=avg; W1=2*W1./ max(W1(:)); '...
  'W2=avg2; W2=W2./ max(W2(:)); '...
'avgfuse = imfuse(W1,W2,''falsecolor'',''Scaling'',''joint'',''ColorChannels'',[1 2 0]);'...
'figure(1); subplot(''Position'',[0.02 0.02 0.37 0.25]); imshow(avgfuse,[]);title(''Fused'');'...
'Vm2=Vmcr((cc2+1+vl)*fr_time*20-1:(2*cc2+vl)*fr_time*20);'...
'figure(1);subplot(''Position'',[0.5 0.02 0.37 0.3]);plot((1:cc*fr_time/0.05)*0.05,Vm ,(1:cc2*fr_time2/0.05)*0.05,Vm2 );grid(''on'');'...
'clearvars  w* W*;']);


uicontrol(fs,'Style','push','Fontsize',8,'Units','normalized',...
 'Position',[0.45 0.79 0.03 0.03],'String','<-V2',...
  'Callback',['vl=vl-1;'...
  'Ya2=Yacr(ca2+1+xu:2*ca2+xu,cb2+1+xl:2*cb2+xl,cc2+1+vl:2*cc2+vl);'...
 'avg2=(mean(Ya2(:,:,1:cc),3));'...
 'figure(1);subplot(''Position'',[0.02 0.35 0.37 0.25]);imshow(avg2,[]);'...
  'W1=avg; W1=2*W1./ max(W1(:)); '...
  'W2=avg2; W2=W2./ max(W2(:)); '...
'avgfuse = imfuse(W1,W2,''falsecolor'',''Scaling'',''joint'',''ColorChannels'',[1 2 0]);'...
'figure(1); subplot(''Position'',[0.02 0.02 0.37 0.25]); imshow(avgfuse,[]);title(''Fused'');'...
'Vm2=Vmcr((cc2+1+vl)*fr_time*20-1:(2*cc2+vl)*fr_time*20);'...
'figure(1);subplot(''Position'',[0.5 0.02 0.37 0.3]);plot((1:cc*fr_time/0.05)*0.05,Vm ,(1:cc2*fr_time2/0.05)*0.05,Vm2 );grid(''on'');'...
'clearvars  w* W*;']);



uicontrol(fs,'Style','push','BackGroundColor',[0.6 0.9 0.9],'Units','normalized',...
 'String','Save files','Position',[0.41 0.7 0.07 0.03],...
 'Callback',['favgfile=[''aC'',ffile(3:end)];sfile=fullfile(fpath,favgfile);'...
 'Y=Ya; save(sfile,''Y''); clear Y;'...
 'favgfile=[''C'',ffile(3:end)];sfile=fullfile(fpath,favgfile);'...
 'Y1=Vm; acq_t=fr_time; save(sfile,''Y1'',''acq_t'');'...
 'favgfile=[''aC'',ffile2(3:end)];sfile=fullfile(fpath2,favgfile);'...
 'Y=Ya2; save(sfile,''Y''); clear Y;'...
 'favgfile=[''C'',ffile2(3:end)];sfile=fullfile(fpath2,favgfile);'...
 'Y1=Vm2;acq_t=fr_time2;save(sfile,''Y1'',''acq_t'');'...
 'clear Y1; clear acq_t;']);

uicontrol(fs,'Style','push','Fontsize',8,'BackGroundColor',[0.7 0.8 0.9],'Units','normalized',...
 'Position',[0.445 0.14 0.035 0.03],'String','next2',...
  'Callback',['clearvars avg2 avgfuse ca2 cb2 cc2 favgfile  fr_time2 sfile Vm2 Vmcr Ya2 Yacr;'...
  'vl=0; xu=0; xl=0; '... 
  ' if str2num(ffile2(end-5:end-4))<100,',...
 'w1=str2num(ffile2(end-5:end-4))+1;,',...
 'if w1<10,wv1=[''0'',num2str(w1)];',...
 'else,wv1=num2str(w1);end,',...
'ffile2(end-5:end-4)=wv1;end,set (z_name2 , ''string'', ffile2);',...
 'eval([''load '',fpath2 ''\'' ffile2]);,',...
 'Ya2=double(Y); [ca2 cb2 cc2]= size(Ya2); clear Y;'...
 'avg2=(mean(Ya2(:,:,1:cc2),3));'...
 'figure(1); subplot(''Position'',[0.02 0.35 0.37 0.25]); imshow(avg2,[]);title(''Image2'');'...
 'set(z_frames2 ,''string'', cc2); set (z_name2 , ''string'', ffile2);'...
 'if (exist([fpath2 ''\'' ffile2(2:end)])),'...
'Phys2 = load([fpath2 ''\'' ffile2(2:end)]);  Vm2=Phys2.Y1(1:cc*fr_time/0.05);'...
'if fr_finaltime==0,fr_time2=str2num(Phys2.acq_t);else, fr_time2=finaltime;end;'...
'clear Phys2;'...
'figure(1);subplot(''Position'',[0.5 0.33 0.37 0.3]);plot((1:cc2*fr_time2/0.05)*0.05,Vm2 );grid(''on'');end;'...
'WX=ones(3*ca2,cb2,cc2);'...
'for wi=1:ca2,WX(wi,:,:)=WX(wi,:,:).*Ya2(1,:,:);end;'...
'WX(ca2+1:2*ca2,:,:)=Ya2(:,:,:);'...
'for wi=2*ca2+1:3*ca2, WX(wi,:,:)=WX(wi,:,:).*Ya2(ca2,:,:);end;'...
'WY=ones(3*ca2,3*cb2,cc2);'...
'for wi=1:cb2,WY(:,wi,:)=WX(:,1,:);end;'...
'WY(:,cb2+1:2*cb2,:)=WX(:,:,:);'...
'for wi=2*cb2+1:3*cb2,WY(:,wi,:)=WX(:,cb2,:);end;'...
'WZ=ones(3*ca2,3*cb2,3*cc2);'...
'for wi=1:cc2,WZ(:,:,wi)=WY(:,:,1);end;'...
'WZ(:,:,cc2+1:2*cc2)=WY;'...
'for wi=2*cc2+1:3*cc2,WZ(:,:,wi)=WY(:,:,cc2);end;'...
 'Yacr=ones(size(WZ)); Yacr=WZ;'...
 'for wi=1:size(Vm2), Vmcr(wi,1)=Vm2(1);end;'...
 'Vmcr(size(Vm2)+1:2*size(Vm2),1)=Vm2;'...
 'for wi=2*size(Vm2)+1:3*size(Vm2), Vmcr(wi,1)=Vm2(end);end;'...
'clearvars  w* W*;']);

uicontrol(fs,'Style','push','Fontsize',8,'BackGroundColor',[0.7 0.8 0.9],'Units','normalized',...
 'Position',[0.41 0.14 0.035 0.03],'String','previous',...
  'Callback',['clearvars avg2 avgfuse ca2 cb2 cc2 favgfile  fr_time2 sfile Vm2 Vmcr Ya2 Yacr;'...
  'vl=0; xu=0; xl=0; '... 
' if str2num(ffile2(end-5:end-4))>1,',...
'w1=str2num(ffile2(end-5:end-4))-1;,',...
'if w1<10,wv1=[''0'',num2str(w1)];',...
'else,wv1=num2str(w1);end,',...
'ffile2(end-5:end-4)=wv1;end,set (z_name2 , ''string'', ffile2);',...
 'eval([''load '',fpath2 ''\'' ffile2]);,',...
 'Ya2=double(Y); [ca2 cb2 cc2]= size(Ya2); clear Y;'...
 'avg2=(mean(Ya2(:,:,1:cc2),3));'...
 'figure(1); subplot(''Position'',[0.02 0.35 0.37 0.25]); imshow(avg2,[]);title(''Image2'');'...
 'set(z_frames2 ,''string'', cc2); set (z_name2 , ''string'', ffile2);'...
 'if (exist([fpath2 ''\'' ffile2(2:end)])),'...
'Phys2 = load([fpath2 ''\'' ffile2(2:end)]);  Vm2=Phys2.Y1(1:cc*fr_time/0.05);'...
'if fr_finaltime==0,fr_time2=str2num(Phys2.acq_t);else, fr_time2=finaltime;end;'...
'clear Phys2;'...
'figure(1);subplot(''Position'',[0.5 0.33 0.37 0.3]);plot((1:cc2*fr_time2/0.05)*0.05,Vm2 );grid(''on'');end;'...
'WX=ones(3*ca2,cb2,cc2);'...
'for wi=1:ca2,WX(wi,:,:)=WX(wi,:,:).*Ya2(1,:,:);end;'...
'WX(ca2+1:2*ca2,:,:)=Ya2(:,:,:);'...
'for wi=2*ca2+1:3*ca2, WX(wi,:,:)=WX(wi,:,:).*Ya2(ca2,:,:);end;'...
'WY=ones(3*ca2,3*cb2,cc2);'...
'for wi=1:cb2,WY(:,wi,:)=WX(:,1,:);end;'...
'WY(:,cb2+1:2*cb2,:)=WX(:,:,:);'...
'for wi=2*cb2+1:3*cb2,WY(:,wi,:)=WX(:,cb2,:);end;'...
'WZ=ones(3*ca2,3*cb2,3*cc2);'...
'for wi=1:cc2,WZ(:,:,wi)=WY(:,:,1);end;'...
'WZ(:,:,cc2+1:2*cc2)=WY;'...
'for wi=2*cc2+1:3*cc2,WZ(:,:,wi)=WY(:,:,cc2);end;'...
 'Yacr=ones(size(WZ)); Yacr=WZ;'...
 'for wi=1:size(Vm2), Vmcr(wi,1)=Vm2(1);end;'...
 'Vmcr(size(Vm2)+1:2*size(Vm2),1)=Vm2;'...
 'for wi=2*size(Vm2)+1:3*size(Vm2), Vmcr(wi,1)=Vm2(end);end;'...
'clearvars  w* W*;']);